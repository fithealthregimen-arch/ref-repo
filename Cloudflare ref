// Cloudflare Worker for QR Code File Upload & Sharing Tool
// Deploy this to: https://qr-code-scanner.creativeaspirant101.workers.dev

export default {
  async fetch(request, env, ctx) {
    const url = new URL(request.url);
    const path = url.pathname;

    // Handle CORS for all requests
    const corsHeaders = {
      'Access-Control-Allow-Origin': '*',
      'Access-Control-Allow-Methods': 'GET, POST, OPTIONS',
      'Access-Control-Allow-Headers': 'Content-Type',
    };

    // Handle preflight OPTIONS requests
    if (request.method === 'OPTIONS') {
      return new Response(null, { status: 200, headers: corsHeaders });
    }

    try {
      // Route: POST /upload - Handle file uploads
      if (path === '/upload' && request.method === 'POST') {
        return await handleUpload(request, env, corsHeaders);
      }

      // Route: GET /view/<id> - Serve files
      if (path.startsWith('/view/') && request.method === 'GET') {
        const fileId = path.substring(6); // Remove '/view/'
        return await handleView(fileId, env, corsHeaders, request);
      }

      // Route: GET /download/<id> - Force download files
      if (path.startsWith('/download/') && request.method === 'GET') {
        const fileId = path.substring(10); // Remove '/download/'
        return await handleDownload(fileId, env, corsHeaders);
      }

      // Route: POST /send-email - Send email notifications
      if (path === '/send-email' && request.method === 'POST') {
        return await handleSendEmail(request, env, corsHeaders);
      }

      // Default route - API info
      return new Response(
        JSON.stringify({
          message: 'QR Code Generator API',
          endpoints: {
            'POST /upload': 'Upload a file and generate QR code',
            'GET /view/<id>': 'View uploaded file',
            'GET /download/<id>': 'Download uploaded file'
          },
          poweredBy: 'Creative Aspirant - https://creativeaspirant.com'
        }),
        {
          status: 200,
          headers: {
            ...corsHeaders,
            'Content-Type': 'application/json'
          }
        }
      );

    } catch (error) {
      console.error('Worker error:', error);
      return new Response(
        JSON.stringify({ 
          error: 'Internal server error',
          message: error.message 
        }),
        {
          status: 500,
          headers: {
            ...corsHeaders,
            'Content-Type': 'application/json'
          }
        }
      );
    }
  },
};

// Handle file upload
async function handleUpload(request, env, corsHeaders) {
  try {
    // Debug: Check if bindings are available
    console.log('Checking bindings:', {
      hasQRStorage: !!env.QR_STORAGE,
      hasQRStorageLower: !!env.qr_storage,
      hasR2Bucket: !!env.R2_BUCKET,
      hasQrCodeGenerator: !!env['qr-code-generator'],
      hasKVBinding: !!env.MY_BINDING,
      hasKVBindingLower: !!env.my_binding,
      hasKV: !!env.KV,
      envKeys: Object.keys(env)
    });

    // Handle multiple possible R2 binding names (including the actual dashboard name)
    const r2Binding = env.QR_STORAGE || env.qr_storage || env.R2_BUCKET || env['qr-code-generator'];
    if (!r2Binding) {
      throw new Error('R2 binding not found (tried QR_STORAGE, qr_storage, R2_BUCKET, qr-code-generator)');
    }
    
    // Handle multiple possible KV binding names (including the actual dashboard name)
    const kvBinding = env.MY_BINDING || env.my_binding || env.KV;
    if (!kvBinding) {
      throw new Error('KV binding not found (tried MY_BINDING, my_binding, KV)');
    }

    const formData = await request.formData();
    const file = formData.get('file');
    const privacySettings = formData.get('privacySettings');

    if (!file) {
      return new Response(
        JSON.stringify({ error: 'No file provided' }),
        {
          status: 400,
          headers: { ...corsHeaders, 'Content-Type': 'application/json' }
        }
      );
    }
    
    // Parse privacy settings if provided
    let privacy = {};
    if (privacySettings) {
      try {
        privacy = JSON.parse(privacySettings);
        console.log('Privacy settings received:', privacy);
      } catch (e) {
        console.log('Privacy settings parse error:', e);
      }
    }

    // Validate file size (100MB limit)
    const maxSize = 100 * 1024 * 1024; // 100MB
    if (file.size > maxSize) {
      return new Response(
        JSON.stringify({ error: 'File size exceeds 100MB limit' }),
        {
          status: 400,
          headers: { ...corsHeaders, 'Content-Type': 'application/json' }
        }
      );
    }

    // Validate file type (block dangerous files)
    const dangerousExts = ['exe', 'bat', 'cmd', 'scr', 'js', 'vbs', 'ps1', 'sh'];
    const fileName = file.name.toLowerCase();
    const fileExt = fileName.split('.').pop();
    
    if (dangerousExts.includes(fileExt)) {
      return new Response(
        JSON.stringify({ error: 'File type not allowed for security reasons' }),
        {
          status: 400,
          headers: { ...corsHeaders, 'Content-Type': 'application/json' }
        }
      );
    }

    // Generate unique file ID
    const fileId = generateUniqueId();
    
    // Sanitize filename
    const sanitizedFilename = sanitizeFilename(file.name);
    
    // Determine content type
    const contentType = file.type || 'application/octet-stream';
    
    // Upload file to R2
    const fileBuffer = await file.arrayBuffer();
    await r2Binding.put(fileId, fileBuffer, {
      httpMetadata: {
        contentType: contentType,
        contentDisposition: `inline; filename="${sanitizedFilename}"`
      }
    });

    // Store metadata in KV with privacy settings
    const metadata = {
      id: fileId,
      filename: sanitizedFilename,
      originalFilename: file.name,
      size: file.size,
      contentType: contentType,
      uploadDate: new Date().toISOString(),
      uploadTimestamp: Date.now(),
      privacy: privacy, // Include privacy settings
      downloadCount: 0,
      lastAccessed: null
    };

    await kvBinding.put(fileId, JSON.stringify(metadata));

    // Return success response
    return new Response(
      JSON.stringify({
        success: true,
        id: fileId,
        filename: sanitizedFilename,
        size: file.size,
        contentType: contentType,
        viewUrl: `${new URL(request.url).origin}/view/${fileId}`,
        downloadUrl: `${new URL(request.url).origin}/download/${fileId}`
      }),
      {
        status: 200,
        headers: { ...corsHeaders, 'Content-Type': 'application/json' }
      }
    );

  } catch (error) {
    console.error('Upload error:', error);
    return new Response(
      JSON.stringify({ 
        error: 'Upload failed',
        message: error.message 
      }),
      {
        status: 500,
        headers: { ...corsHeaders, 'Content-Type': 'application/json' }
      }
    );
  }
}

// Handle file viewing
async function handleView(fileId, env, corsHeaders, request) {
  try {
    // Validate file ID
    if (!fileId || fileId.length < 8) {
      return new Response('Invalid file ID', { status: 400, headers: corsHeaders });
    }

    // Handle multiple possible binding names (including actual dashboard names)
    const kvBinding = env.MY_BINDING || env.my_binding || env.KV;
    const r2Binding = env.QR_STORAGE || env.qr_storage || env.R2_BUCKET || env['qr-code-generator'];
    
    if (!kvBinding) {
      return new Response('KV binding not configured', { status: 500, headers: corsHeaders });
    }
    if (!r2Binding) {
      return new Response('R2 binding not configured', { status: 500, headers: corsHeaders });
    }

    // Get metadata from KV
    const metadataStr = await kvBinding.get(fileId);
    if (!metadataStr) {
      return new Response('File not found', { status: 404, headers: corsHeaders });
    }

    const metadata = JSON.parse(metadataStr);
    
    // Check for password protection
    if (metadata.privacy && metadata.privacy.passwordProtected) {
      const url = new URL(request.url);
      const providedPassword = url.searchParams.get('password');
      
      if (!providedPassword || providedPassword !== metadata.privacy.password) {
        const passwordHtml = generatePasswordHtml(fileId, metadata.filename);
        return new Response(passwordHtml, {
          status: 200,
          headers: { ...corsHeaders, 'Content-Type': 'text/html' }
        });
      }
    }
    
    // Check download limits
    if (metadata.privacy && metadata.privacy.downloadLimit) {
      const downloadCount = metadata.downloadCount || 0;
      const maxDownloads = metadata.privacy.maxDownloads || 10;
      
      if (downloadCount >= maxDownloads) {
        const errorHtml = generateErrorHtml('Download Limit Reached', 'This file has reached its maximum download limit.');
        return new Response(errorHtml, {
          status: 403,
          headers: { ...corsHeaders, 'Content-Type': 'text/html' }
        });
      }
    }
    
    // Update access tracking
    metadata.lastAccessed = new Date().toISOString();
    metadata.downloadCount = (metadata.downloadCount || 0) + 1;
    await kvBinding.put(fileId, JSON.stringify(metadata));
    
    // Get file from R2
    const file = await r2Binding.get(fileId);
    if (!file) {
      return new Response('File data not found', { status: 404, headers: corsHeaders });
    }

    // Determine how to display the file
    const contentType = metadata.contentType.toLowerCase();
    const filename = metadata.filename;
    const fileExt = filename.toLowerCase().split('.').pop();

    // Generate HTML response for file viewing  
    const html = generateViewHtml(metadata, fileId, request.url);

    return new Response(html, {
      status: 200,
      headers: {
        ...corsHeaders,
        'Content-Type': 'text/html; charset=utf-8',
        'Cache-Control': 'public, max-age=3600'
      }
    });

  } catch (error) {
    console.error('View error:', error);
    return new Response(
      `Error loading file: ${error.message}`,
      { status: 500, headers: corsHeaders }
    );
  }
}

// Handle file download
async function handleDownload(fileId, env, corsHeaders) {
  try {
    // Validate file ID
    if (!fileId || fileId.length < 8) {
      return new Response('Invalid file ID', { status: 400, headers: corsHeaders });
    }

    // Handle multiple possible binding names (including actual dashboard names)
    const kvBinding = env.MY_BINDING || env.my_binding || env.KV;
    const r2Binding = env.QR_STORAGE || env.qr_storage || env.R2_BUCKET || env['qr-code-generator'];
    
    if (!kvBinding) {
      return new Response('KV binding not configured', { status: 500, headers: corsHeaders });
    }
    if (!r2Binding) {
      return new Response('R2 binding not configured', { status: 500, headers: corsHeaders });
    }

    // Get metadata from KV
    const metadataStr = await kvBinding.get(fileId);
    if (!metadataStr) {
      return new Response('File not found', { status: 404, headers: corsHeaders });
    }

    const metadata = JSON.parse(metadataStr);
    
    // Get file from R2
    const file = await r2Binding.get(fileId);
    if (!file) {
      return new Response('File data not found', { status: 404, headers: corsHeaders });
    }

    // Return file with download headers
    return new Response(file.body, {
      status: 200,
      headers: {
        ...corsHeaders,
        'Content-Type': metadata.contentType,
        'Content-Disposition': `attachment; filename="${metadata.filename}"`,
        'Content-Length': metadata.size.toString(),
        'Cache-Control': 'public, max-age=3600'
      }
    });

  } catch (error) {
    console.error('Download error:', error);
    return new Response(
      `Error downloading file: ${error.message}`,
      { status: 500, headers: corsHeaders }
    );
  }
}

// Generate unique ID for files
function generateUniqueId() {
  const timestamp = Date.now().toString(36);
  const randomStr = Math.random().toString(36).substring(2, 8);
  return `${timestamp}-${randomStr}`;
}

// Sanitize filename to prevent security issues
function sanitizeFilename(filename) {
  return filename
    .replace(/[^a-zA-Z0-9._-]/g, '_')
    .replace(/_{2,}/g, '_')
    .substring(0, 255);
}

// Format file size
function formatFileSize(bytes) {
  if (bytes === 0) return '0 Bytes';
  const k = 1024;
  const sizes = ['Bytes', 'KB', 'MB', 'GB'];
  const i = Math.floor(Math.log(bytes) / Math.log(k));
  return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

// Get file icon based on extension
function getFileIcon(filename) {
  const ext = filename.toLowerCase().split('.').pop();
  const icons = {
    pdf: 'üìÑ', doc: 'üìù', docx: 'üìù', xls: 'üìä', xlsx: 'üìä',
    ppt: 'üìà', pptx: 'üìà', jpg: 'üñºÔ∏è', jpeg: 'üñºÔ∏è', png: 'üñºÔ∏è',
    gif: 'üñºÔ∏è', svg: 'üñºÔ∏è', txt: 'üìã', zip: 'üóúÔ∏è', rar: 'üóúÔ∏è',
    mp4: 'üé•', avi: 'üé•', mov: 'üé•', mp3: 'üéµ', wav: 'üéµ'
  };
  return icons[ext] || 'üìÅ';
}

// Handle email sending
async function handleSendEmail(request, env, corsHeaders) {
  try {
    const { to, subject, message, fileUrl, fileName } = await request.json();
    
    if (!to || !subject || !fileUrl) {
      return new Response(
        JSON.stringify({ error: 'Missing required fields: to, subject, fileUrl' }),
        {
          status: 400,
          headers: { ...corsHeaders, 'Content-Type': 'application/json' }
        }
      );
    }

    // Get Brevo API key from environment variables
    const brevoApiKey = env.BREVO_API_KEY;
    if (!brevoApiKey) {
      return new Response(
        JSON.stringify({ error: 'Email service not configured' }),
        {
          status: 500,
          headers: { ...corsHeaders, 'Content-Type': 'application/json' }
        }
      );
    }

    // Prepare email content
    const emailContent = `
      <html>
        <body style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px;">
          <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; border-radius: 10px; text-align: center; margin-bottom: 30px;">
            <h1 style="margin: 0; font-size: 28px;">üì± File Shared via QR Code</h1>
            <p style="margin: 10px 0 0 0; opacity: 0.9;">Powered by Creative Aspirant</p>
          </div>
          
          <div style="background: #f8f9fa; padding: 25px; border-radius: 10px; margin-bottom: 25px;">
            <h2 style="color: #333; margin-top: 0;">üìÑ ${fileName || 'Shared File'}</h2>
            <p style="color: #666; line-height: 1.6;">${message || 'Someone has shared a file with you using our QR Code Generator.'}</p>
          </div>
          
          <div style="text-align: center; margin: 30px 0;">
            <a href="${fileUrl}" style="background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 15px 30px; text-decoration: none; border-radius: 8px; font-weight: bold; display: inline-block;">
              üîó Access File
            </a>
          </div>
          
          <div style="background: #e3f2fd; padding: 20px; border-radius: 8px; margin: 25px 0;">
            <h3 style="color: #1976d2; margin-top: 0;">üì± Mobile Access</h3>
            <p style="color: #666; margin-bottom: 0;">You can also scan the QR code with your mobile device for quick access.</p>
          </div>
          
          <div style="border-top: 1px solid #eee; padding-top: 20px; text-align: center; color: #666; font-size: 14px;">
            <p>This file was shared using <a href="https://creativeaspirant.com/qr-code-generator/" style="color: #667eea;">Creative Aspirant QR Code Generator</a></p>
            <p style="margin: 5px 0 0 0;">üöÄ Unlock Creativity & Productivity</p>
          </div>
        </body>
      </html>
    `;

    // Send email via Brevo API
    console.log('Sending email via Brevo API to:', to);
    console.log('Using API key:', brevoApiKey ? brevoApiKey.substring(0, 10) + '...' : 'NOT SET');
    
    const emailPayload = {
              sender: {
          name: 'Creative Aspirant QR Generator',
          email: env.FROM_EMAIL || 'hi@creativeaspirant.com'
        },
      to: [{ email: to }],
      subject: subject,
      htmlContent: emailContent
    };
    
    console.log('Email payload:', JSON.stringify(emailPayload, null, 2));
    
    const brevoResponse = await fetch('https://api.brevo.com/v3/smtp/email', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'api-key': brevoApiKey
      },
      body: JSON.stringify(emailPayload)
    });

    if (brevoResponse.ok) {
      return new Response(
        JSON.stringify({ 
          success: true, 
          message: 'Email sent successfully' 
        }),
        {
          status: 200,
          headers: { ...corsHeaders, 'Content-Type': 'application/json' }
        }
      );
    } else {
      const errorText = await brevoResponse.text();
      console.error('Brevo API error:', errorText);
      
      return new Response(
        JSON.stringify({ 
          error: 'Failed to send email', 
          details: errorText 
        }),
        {
          status: 500,
          headers: { ...corsHeaders, 'Content-Type': 'application/json' }
        }
      );
    }

  } catch (error) {
    console.error('Email sending error:', error);
    return new Response(
      JSON.stringify({ 
        error: 'Email sending failed', 
        message: error.message 
      }),
      {
        status: 500,
        headers: { ...corsHeaders, 'Content-Type': 'application/json' }
      }
    );
  }
}

// Generate password protection HTML
function generatePasswordHtml(fileId, filename) {
  return `
    <!DOCTYPE html>
    <html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Password Protected File - Creative Aspirant</title>
        <style>
            body {
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                margin: 0;
                padding: 20px;
                min-height: 100vh;
                display: flex;
                align-items: center;
                justify-content: center;
            }
            .container {
                background: white;
                border-radius: 16px;
                padding: 40px;
                max-width: 400px;
                width: 100%;
                box-shadow: 0 20px 40px rgba(0,0,0,0.1);
                text-align: center;
            }
            .icon {
                font-size: 48px;
                margin-bottom: 20px;
            }
            h1 {
                color: #333;
                margin-bottom: 10px;
                font-size: 24px;
            }
            p {
                color: #666;
                margin-bottom: 30px;
                line-height: 1.5;
            }
            .filename {
                background: #f8f9fa;
                padding: 10px 15px;
                border-radius: 8px;
                margin: 20px 0;
                font-weight: 500;
                color: #495057;
            }
            input[type="password"] {
                width: 100%;
                padding: 12px 16px;
                border: 2px solid #e9ecef;
                border-radius: 8px;
                font-size: 16px;
                margin-bottom: 20px;
                box-sizing: border-box;
                transition: border-color 0.3s;
            }
            input[type="password"]:focus {
                outline: none;
                border-color: #667eea;
            }
            button {
                background: linear-gradient(135deg, #667eea, #764ba2);
                color: white;
                border: none;
                padding: 12px 30px;
                border-radius: 8px;
                font-size: 16px;
                cursor: pointer;
                width: 100%;
                transition: transform 0.2s;
            }
            button:hover {
                transform: translateY(-1px);
            }
            .footer {
                margin-top: 30px;
                padding-top: 20px;
                border-top: 1px solid #eee;
                font-size: 14px;
                color: #666;
            }
            .error {
                color: #dc3545;
                margin-top: 10px;
                font-size: 14px;
            }
        </style>
    </head>
    <body>
        <div class="container">
            <div class="icon">üîí</div>
            <h1>Password Protected</h1>
            <p>This file is password protected. Please enter the password to access it.</p>
            <div class="filename">üìÑ ${filename}</div>
            
            <form id="passwordForm">
                <input type="password" id="passwordInput" placeholder="Enter password" required>
                <button type="submit">Access File</button>
            </form>
            
            <div id="error" class="error" style="display: none;"></div>
            
            <div class="footer">
                <p>Protected by <strong>Creative Aspirant QR Generator</strong></p>
            </div>
        </div>
        
        <script>
            document.getElementById('passwordForm').addEventListener('submit', function(e) {
                e.preventDefault();
                const password = document.getElementById('passwordInput').value;
                const url = new URL(window.location);
                url.searchParams.set('password', password);
                window.location.href = url.toString();
            });
            
            // Check if there's an error in the URL
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.has('password') && window.location.search.includes('password=')) {
                document.getElementById('error').textContent = 'Incorrect password. Please try again.';
                document.getElementById('error').style.display = 'block';
            }
        </script>
    </body>
    </html>
  `;
}

// Generate error HTML
function generateErrorHtml(title, message) {
  return `
    <!DOCTYPE html>
    <html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>${title} - Creative Aspirant</title>
        <style>
            body {
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                margin: 0;
                padding: 20px;
                min-height: 100vh;
                display: flex;
                align-items: center;
                justify-content: center;
            }
            .container {
                background: white;
                border-radius: 16px;
                padding: 40px;
                max-width: 500px;
                width: 100%;
                box-shadow: 0 20px 40px rgba(0,0,0,0.1);
                text-align: center;
            }
            .icon {
                font-size: 64px;
                margin-bottom: 20px;
            }
            h1 {
                color: #dc3545;
                margin-bottom: 15px;
                font-size: 28px;
            }
            p {
                color: #666;
                margin-bottom: 30px;
                line-height: 1.6;
                font-size: 16px;
            }
            .back-btn {
                background: linear-gradient(135deg, #667eea, #764ba2);
                color: white;
                text-decoration: none;
                padding: 12px 24px;
                border-radius: 8px;
                display: inline-block;
                transition: transform 0.2s;
            }
            .back-btn:hover {
                transform: translateY(-1px);
            }
            .footer {
                margin-top: 30px;
                padding-top: 20px;
                border-top: 1px solid #eee;
                font-size: 14px;
                color: #666;
            }
        </style>
    </head>
    <body>
        <div class="container">
            <div class="icon">‚ö†Ô∏è</div>
            <h1>${title}</h1>
            <p>${message}</p>
            <a href="https://creativeaspirant.com/qr-code-generator/" class="back-btn">Visit Creative Aspirant</a>
            <div class="footer">
                <p>Powered by <strong>Creative Aspirant QR Generator</strong></p>
            </div>
        </div>
    </body>
    </html>
  `;
}

// Get simplified file type display
function getSimpleFileType(contentType, filename) {
  const ext = filename.toLowerCase().split('.').pop();
  
  // Map complex MIME types to simple names
  const typeMap = {
    // Documents
    'application/pdf': 'PDF Document',
    'application/msword': 'Word Document',
    'application/vnd.openxmlformats-officedocument.wordprocessingml.document': 'Word Document',
    'application/vnd.ms-excel': 'Excel Spreadsheet',
    'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet': 'Excel Spreadsheet',
    'application/vnd.ms-powerpoint': 'PowerPoint Presentation',
    'application/vnd.openxmlformats-officedocument.presentationml.presentation': 'PowerPoint Presentation',
    'text/plain': 'Text File',
    'text/csv': 'CSV File',
    'application/rtf': 'Rich Text Document',
    
    // Images
    'image/jpeg': 'JPEG Image',
    'image/jpg': 'JPEG Image',
    'image/png': 'PNG Image',
    'image/gif': 'GIF Image',
    'image/svg+xml': 'SVG Image',
    'image/webp': 'WebP Image',
    'image/bmp': 'BMP Image',
    'image/tiff': 'TIFF Image',
    
    // Archives
    'application/zip': 'ZIP Archive',
    'application/x-rar-compressed': 'RAR Archive',
    'application/x-7z-compressed': '7Z Archive',
    'application/gzip': 'GZIP Archive',
    
    // Audio
    'audio/mpeg': 'MP3 Audio',
    'audio/wav': 'WAV Audio',
    'audio/ogg': 'OGG Audio',
    
    // Video
    'video/mp4': 'MP4 Video',
    'video/avi': 'AVI Video',
    'video/quicktime': 'MOV Video',
    
    // Other
    'application/json': 'JSON File',
    'application/xml': 'XML File',
    'text/html': 'HTML File',
    'text/css': 'CSS File',
    'application/javascript': 'JavaScript File'
  };
  
  // First try exact MIME type match
  if (typeMap[contentType]) {
    return typeMap[contentType];
  }
  
  // Then try by extension
  const extMap = {
    'pdf': 'PDF Document',
    'doc': 'Word Document',
    'docx': 'Word Document',
    'xls': 'Excel Spreadsheet',
    'xlsx': 'Excel Spreadsheet',
    'ppt': 'PowerPoint Presentation',
    'pptx': 'PowerPoint Presentation',
    'txt': 'Text File',
    'csv': 'CSV File',
    'rtf': 'Rich Text Document',
    'jpg': 'JPEG Image',
    'jpeg': 'JPEG Image',
    'png': 'PNG Image',
    'gif': 'GIF Image',
    'svg': 'SVG Image',
    'webp': 'WebP Image',
    'bmp': 'BMP Image',
    'tiff': 'TIFF Image',
    'zip': 'ZIP Archive',
    'rar': 'RAR Archive',
    '7z': '7Z Archive',
    'gz': 'GZIP Archive',
    'mp3': 'MP3 Audio',
    'wav': 'WAV Audio',
    'ogg': 'OGG Audio',
    'mp4': 'MP4 Video',
    'avi': 'AVI Video',
    'mov': 'MOV Video',
    'json': 'JSON File',
    'xml': 'XML File',
    'html': 'HTML File',
    'css': 'CSS File',
    'js': 'JavaScript File'
  };
  
  if (extMap[ext]) {
    return extMap[ext];
  }
  
  // Fallback to extension in uppercase
  return ext ? `${ext.toUpperCase()} File` : 'Unknown File';
}

// Generate HTML for file viewing with monetization// Updated generateViewHtml function for cloudflare-worker.js
// Replace the existing generateViewHtml function with this version

function generateViewHtml(metadata, fileId, requestUrl) {
  const baseUrl = new URL(requestUrl).origin;
  const downloadUrl = `${baseUrl}/download/${fileId}`;
  const contentType = metadata.contentType.toLowerCase();
  const filename = metadata.filename;
  const fileExt = filename.toLowerCase().split('.').pop();
  const simpleFileType = getSimpleFileType(contentType, filename);
  const uploadDate = new Date(metadata.uploadDate).toLocaleDateString();
  const fileIcon = getFileIcon(filename);

  let fileDisplay = '';
  
  // Enhanced file display logic with better viewing capabilities
  if (contentType.startsWith('image/')) {
    const imageUrl = `${baseUrl}/download/${fileId}`;
    fileDisplay = `
      <div class="text-center mb-6">
        <div class="relative inline-block">
          <img src="${imageUrl}" alt="${filename}" 
               class="max-w-full h-auto rounded-lg shadow-lg mx-auto cursor-pointer hover:shadow-xl transition-shadow" 
               style="max-height: 600px;" 
               onclick="openFullscreen(this)"
               title="Click to view fullscreen">
          <div class="absolute top-2 right-2 bg-black bg-opacity-50 text-white px-2 py-1 rounded text-xs">
            üîç Click to zoom
          </div>
        </div>
        <p class="text-sm text-gray-600 mt-2">Click image for fullscreen view</p>
      </div>
    `;
  } else if (contentType === 'application/pdf') {
    const pdfUrl = `${baseUrl}/download/${fileId}`;
    fileDisplay = `
      <div class="mb-6">
        <div class="relative">
          <iframe src="${pdfUrl}" width="100%" height="600" class="rounded-lg shadow-lg border-0"></iframe>
          <div class="flex justify-center mt-3 space-x-4">
            <button onclick="toggleFullscreenPDF('${pdfUrl}')" 
                    class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors">
              üìñ View Fullscreen
            </button>
            <a href="${pdfUrl}" target="_blank" 
               class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors">
              üîó Open in New Tab
            </a>
          </div>
        </div>
        <p class="text-center text-sm text-gray-600 mt-2">
          üì± Mobile tip: Use fullscreen or new tab for better reading experience
        </p>
      </div>
    `;
  } else if (contentType.startsWith('text/') || fileExt === 'txt') {
    fileDisplay = `
      <div class="mb-6">
        <div class="bg-gray-50 rounded-lg border">
          <div class="flex justify-between items-center p-3 border-b bg-gray-100 rounded-t-lg">
            <h4 class="font-medium text-gray-700">üìÑ Text File Preview</h4>
            <button onclick="loadTextPreview('${baseUrl}/download/${fileId}')" 
                    class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-sm">
              üëÅÔ∏è Load Preview
            </button>
          </div>
          <div id="text-preview" class="p-4 min-h-[200px] max-h-[400px] overflow-auto">
            <p class="text-center text-gray-500 italic">Click "Load Preview" to view file content</p>
          </div>
        </div>
      </div>
    `;
  } else if (contentType.startsWith('video/')) {
    const videoUrl = `${baseUrl}/download/${fileId}`;
    fileDisplay = `
      <div class="mb-6 text-center">
        <video controls class="max-w-full h-auto rounded-lg shadow-lg mx-auto" style="max-height: 500px;">
          <source src="${videoUrl}" type="${contentType}">
          Your browser does not support the video tag.
        </video>
        <p class="text-sm text-gray-600 mt-2">üé¨ Video file - Click play to watch</p>
      </div>
    `;
  } else if (contentType.startsWith('audio/')) {
    const audioUrl = `${baseUrl}/download/${fileId}`;
    fileDisplay = `
      <div class="mb-6 p-6 bg-gradient-to-br from-purple-50 to-indigo-100 rounded-lg text-center">
        <div class="text-6xl mb-4">üéµ</div>
        <h3 class="text-lg font-medium text-gray-800 mb-4">${filename}</h3>
        <audio controls class="w-full max-w-md mx-auto mb-4">
          <source src="${audioUrl}" type="${contentType}">
          Your browser does not support the audio element.
        </audio>
        <p class="text-sm text-gray-600">üéß Audio file ready to play</p>
      </div>
    `;
  } else if (contentType.includes('word') || contentType.includes('document') || fileExt === 'doc' || fileExt === 'docx') {
    fileDisplay = `
      <div class="mb-6 p-6 bg-gradient-to-br from-blue-50 to-indigo-100 rounded-lg text-center">
        <div class="text-6xl mb-4">üìù</div>
        <h3 class="text-lg font-medium text-gray-800 mb-4">${filename}</h3>
        <p class="text-gray-600 mb-4">Word Document</p>
        <div class="space-y-3">
          <a href="https://view.officeapps.live.com/op/embed.aspx?src=${encodeURIComponent(baseUrl + '/download/' + fileId)}" 
             target="_blank" 
             class="inline-block bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-medium transition-colors">
            üìñ View Online (Office)
          </a>
          <p class="text-xs text-gray-500">Try viewing with Microsoft Office Online</p>
        </div>
      </div>
    `;
  } else if (contentType.includes('spreadsheet') || contentType.includes('excel') || fileExt === 'xls' || fileExt === 'xlsx') {
    fileDisplay = `
      <div class="mb-6 p-6 bg-gradient-to-br from-green-50 to-emerald-100 rounded-lg text-center">
        <div class="text-6xl mb-4">üìä</div>
        <h3 class="text-lg font-medium text-gray-800 mb-4">${filename}</h3>
        <p class="text-gray-600 mb-4">Excel Spreadsheet</p>
        <div class="space-y-3">
          <a href="https://view.officeapps.live.com/op/embed.aspx?src=${encodeURIComponent(baseUrl + '/download/' + fileId)}" 
             target="_blank" 
             class="inline-block bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-lg font-medium transition-colors">
            üìà View Online (Office)
          </a>
          <p class="text-xs text-gray-500">Try viewing with Microsoft Office Online</p>
        </div>
      </div>
    `;
  } else {
    fileDisplay = `
      <div class="mb-6 p-8 bg-gradient-to-br from-gray-50 to-slate-100 rounded-lg text-center">
        <div class="text-6xl mb-4">${fileIcon}</div>
        <h3 class="text-lg font-medium text-gray-800 mb-2">${filename}</h3>
        <p class="text-gray-600 mb-4">${simpleFileType}</p>
        <p class="text-gray-500 text-sm">Download to view this file type</p>
      </div>
    `;
  }

  return `
    <!DOCTYPE html>
    <html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>${filename} - Creative Aspirant QR Generator</title>
        <meta name="description" content="View and download ${filename} - ${simpleFileType} shared via QR Code">
        <meta property="og:title" content="${filename}">
        <meta property="og:description" content="File shared via QR Code - ${simpleFileType}">
        <meta property="og:url" content="${requestUrl}">
        <meta name="robots" content="noindex, nofollow">
        
        <!-- Google AdSense -->
        <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-3577285096347674" crossorigin="anonymous"></script>
        
        <!-- Google Analytics -->
        <script async src="https://www.googletagmanager.com/gtag/js?id=G-XV7EML251X"></script>
        <script>
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());
          gtag('config', 'G-XV7EML251X', {
            page_title: 'QR File View - ${filename}',
            custom_map: {'custom_parameter_1': 'file_type'}
          });
          gtag('event', 'file_view', {
            'file_type': '${simpleFileType}',
            'file_size': '${formatFileSize(metadata.size)}'
          });
        </script>
        
        <style>
            * { box-sizing: border-box; }
            body {
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                margin: 0;
                padding: 0;
                background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
                color: #1a202c;
                line-height: 1.6;
                min-height: 100vh;
            }
            
            .container {
                max-width: 900px;
                margin: 0 auto;
                padding: 20px;
            }
            
            /* Header */
            .header {
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                padding: 2rem;
                border-radius: 20px;
                text-align: center;
                margin-bottom: 2rem;
                box-shadow: 0 20px 40px rgba(102, 126, 234, 0.3);
                position: relative;
                overflow: hidden;
            }
            .header h1 { margin: 0; font-size: 2.5rem; }
            .header p { margin: 0.5rem 0 0 0; opacity: 0.9; }
            
            /* Ad Containers */
            .ad-container {
                background: white;
                border: 2px solid #e2e8f0;
                border-radius: 12px;
                margin: 2rem 0;
                padding: 1.5rem;
                text-align: center;
                min-height: 120px;
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            }
            .ad-label {
                font-size: 11px;
                color: #a0aec0;
                text-transform: uppercase;
                letter-spacing: 1px;
                margin-bottom: 10px;
                font-weight: 600;
            }
            
            /* Content Cards */
            .content-card {
                background: white;
                border-radius: 20px;
                padding: 2.5rem;
                box-shadow: 0 10px 30px rgba(0,0,0,0.1);
                margin-bottom: 2rem;
            }
            
            /* File Info */
            .file-info {
                background: linear-gradient(135deg, #f7fafc 0%, #edf2f7 100%);
                padding: 2rem;
                border-radius: 16px;
                margin: 2rem 0;
                border: 1px solid #e2e8f0;
            }
            .info-item {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 0.75rem 0;
                border-bottom: 1px solid rgba(226, 232, 240, 0.5);
            }
            .info-item:last-child { border-bottom: none; }
            .info-label { color: #718096; font-weight: 500; }
            .info-value { font-weight: 600; color: #2d3748; }
            
            /* Download Button */
            .download-btn {
                background: linear-gradient(135deg, #667eea, #764ba2);
                color: white;
                padding: 18px 36px;
                border: none;
                border-radius: 12px;
                text-decoration: none;
                display: inline-block;
                font-weight: 700;
                font-size: 18px;
                transition: all 0.3s ease;
                box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
                text-transform: uppercase;
                letter-spacing: 1px;
            }
            .download-btn:hover {
                transform: translateY(-3px);
                box-shadow: 0 12px 35px rgba(102, 126, 234, 0.5);
            }
            
            /* Social Sharing */
            .share-section {
                background: white;
                border-radius: 20px;
                padding: 2.5rem;
                box-shadow: 0 10px 30px rgba(0,0,0,0.1);
                margin-bottom: 2rem;
                text-align: center;
            }
            .share-buttons {
                display: flex;
                flex-wrap: wrap;
                justify-content: center;
                gap: 1rem;
                margin: 1.5rem 0;
            }
            .share-btn {
                display: inline-flex;
                align-items: center;
                padding: 12px 20px;
                border-radius: 8px;
                text-decoration: none;
                color: white;
                font-weight: 600;
                transition: all 0.3s ease;
                box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            }
            .share-btn:hover { transform: translateY(-2px); }
            .share-twitter { background: #1da1f2; }
            .share-facebook { background: #4267b2; }
            .share-linkedin { background: #0077b5; }
            .share-whatsapp { background: #25d366; }
            .copy-btn {
                background: #e2e8f0;
                color: #4a5568;
                border: 2px solid #cbd5e0;
                padding: 12px 20px;
                border-radius: 8px;
                cursor: pointer;
                font-weight: 600;
                transition: all 0.3s ease;
            }
            .copy-btn:hover {
                background: #cbd5e0;
                transform: translateY(-1px);
            }
            
            /* Footer */
            .footer {
                background: white;
                border-radius: 20px;
                padding: 3rem;
                box-shadow: 0 10px 30px rgba(0,0,0,0.1);
                text-align: center;
                margin-top: 3rem;
            }
            .feature-tags {
                display: flex;
                flex-wrap: wrap;
                justify-content: center;
                gap: 0.5rem;
                margin: 1.5rem 0;
            }
            .feature-tag {
                padding: 8px 16px;
                border-radius: 20px;
                font-size: 12px;
                font-weight: 600;
                text-transform: uppercase;
                letter-spacing: 0.5px;
            }
            .tag-logo { background: #e6fffa; color: #319795; }
            .tag-security { background: #fef5e7; color: #d69e2e; }
            .tag-analytics { background: #f0fff4; color: #38a169; }
            
            /* Mobile Responsive */
            @media (max-width: 768px) {
                .container { 
                    padding: 15px; 
                    max-width: 100% !important;
                    overflow-x: hidden !important;
                }
                .content-card, .share-section, .footer { 
                    padding: 1.5rem; 
                    max-width: 100% !important;
                    overflow-wrap: break-word !important;
                    word-wrap: break-word !important;
                }
                .header { 
                    padding: 1.5rem; 
                    max-width: 100% !important;
                }
                .header h1 { 
                    font-size: 2rem; 
                    word-wrap: break-word !important;
                    overflow-wrap: break-word !important;
                }
                .share-buttons { 
                    flex-direction: column; 
                    align-items: center; 
                    flex-wrap: wrap !important;
                }
                .share-btn { 
                    width: 200px; 
                    justify-content: center; 
                    max-width: 100% !important;
                }
                .download-btn { 
                    font-size: 16px; 
                    padding: 15px 30px; 
                    max-width: 100% !important;
                    box-sizing: border-box !important;
                }
                
                /* Remove sticky ad padding */
                body { 
                    padding-bottom: 0 !important; 
                    overflow-x: hidden !important;
                    max-width: 100vw !important;
                }
                
                /* Hide mobile sticky ad */
                .mobile-sticky-ad {
                    display: none !important;
                }
                
                /* Fix overflow for all elements */
                * {
                    max-width: 100% !important;
                    word-wrap: break-word !important;
                    overflow-wrap: break-word !important;
                    box-sizing: border-box !important;
                }
                
                /* Specific fixes for images and media */
                img, video, canvas, iframe {
                    max-width: 100% !important;
                    height: auto !important;
                    display: block !important;
                    margin: 0 auto !important;
                }
                
                /* Fix for long URLs and text */
                .share-section input, .share-section a {
                    word-break: break-all !important;
                    overflow-wrap: break-word !important;
                    max-width: 100% !important;
                }
            }
            
            /* Extra small mobile devices */
            @media (max-width: 480px) {
                .container { 
                    padding: 10px !important; 
                    margin: 0 !important;
                }
                .content-card, .share-section, .footer { 
                    padding: 1rem !important; 
                    margin: 0.5rem 0 !important;
                }
                .header { 
                    padding: 1rem !important; 
                }
                .header h1 { 
                    font-size: 1.5rem !important; 
                    line-height: 1.3 !important;
                }
                .download-btn { 
                    font-size: 14px !important; 
                    padding: 12px 20px !important; 
                    width: 100% !important;
                }
                .share-btn { 
                    width: 100% !important; 
                    margin: 0.25rem 0 !important;
                }
                .ad-container {
                    margin: 1rem 0 !important;
                    padding: 0.5rem !important;
                }
            }
        </style>
    </head>
    <body>
        <div class="container">
            <!-- Top Banner Ad -->
            <div class="ad-container">
                <div class="ad-label">Advertisement</div>
                <ins class="adsbygoogle"
                     style="display:block"
                     data-ad-client="ca-pub-3577285096347674"
                     data-ad-format="auto"
                     data-full-width-responsive="true"></ins>
            </div>

            <!-- Header -->
            <div class="header">
                <h1>${fileIcon} ${filename}</h1>
                <p>Shared via Creative Aspirant QR Generator</p>
                <div style="margin-top: 1rem;">
                    <span style="background: rgba(255,255,255,0.2); padding: 8px 20px; border-radius: 25px; font-size: 14px; font-weight: 600;">
                        ${simpleFileType}
                    </span>
                </div>
            </div>

            <!-- File Content -->
            <div class="content-card">
                ${fileDisplay}
                
                <div class="file-info">
                    <h3 style="margin: 0 0 1rem 0; color: #2d3748; font-size: 1.5rem;">üìã File Details</h3>
                    <div>
                        <div class="info-item">
                            <span class="info-label">üìè Size:</span>
                            <span class="info-value">${formatFileSize(metadata.size)}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">üìÑ Type:</span>
                            <span class="info-value">${simpleFileType}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">üìÖ Uploaded:</span>
                            <span class="info-value">${uploadDate}</span>
                        </div>
                    </div>
                </div>

                <div style="text-align: center; margin-top: 3rem;">
                    <a href="${downloadUrl}" class="download-btn" 
                       onclick="gtag('event', 'download', {'file_type': '${simpleFileType}', 'file_name': '${filename}'});">
                        üì• Download File
                    </a>
                </div>
            </div>

            <!-- Middle Banner Ad -->
            <div class="ad-container">
                <div class="ad-label">Advertisement</div>
                <ins class="adsbygoogle"
                     style="display:block"
                     data-ad-client="ca-pub-3577285096347674"
                     data-ad-format="auto"
                     data-full-width-responsive="true"></ins>
            </div>

            <!-- Social Sharing -->
            <div class="share-section">
                <h3 style="color: #2d3748; margin-bottom: 1rem; font-size: 1.8rem;">üì§ Share This File</h3>
                <p style="color: #718096; margin-bottom: 2rem; font-size: 1.1rem;">
                    Help others access this file by sharing the link on social media
                </p>
                <div class="share-buttons">
                    <a href="https://twitter.com/intent/tweet?text=Check out this ${simpleFileType}: ${filename}&url=${encodeURIComponent(requestUrl)}&via=CreativeAspirant" 
                       class="share-btn share-twitter" target="_blank" rel="noopener"
                       onclick="gtag('event', 'share', {'method': 'Twitter', 'content_type': '${simpleFileType}'});">
                        üê¶ Twitter
                    </a>
                    <a href="https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(requestUrl)}" 
                       class="share-btn share-facebook" target="_blank" rel="noopener"
                       onclick="gtag('event', 'share', {'method': 'Facebook', 'content_type': '${simpleFileType}'});">
                        üìò Facebook
                    </a>
                    <a href="https://www.linkedin.com/sharing/share-offsite/?url=${encodeURIComponent(requestUrl)}" 
                       class="share-btn share-linkedin" target="_blank" rel="noopener"
                       onclick="gtag('event', 'share', {'method': 'LinkedIn', 'content_type': '${simpleFileType}'});">
                        üíº LinkedIn
                    </a>
                    <a href="https://wa.me/?text=${encodeURIComponent('Check out this file: ' + filename + ' - ' + requestUrl)}" 
                       class="share-btn share-whatsapp" target="_blank" rel="noopener"
                       onclick="gtag('event', 'share', {'method': 'WhatsApp', 'content_type': '${simpleFileType}'});">
                        üí¨ WhatsApp
                    </a>
                </div>
                <div style="margin-top: 1.5rem;">
                    <button onclick="copyLink()" class="copy-btn">
                        üìã Copy Link to Clipboard
                    </button>
                </div>
            </div>

            <!-- Footer CTA -->
            <div class="footer">
                <h3 style="color: #2d3748; margin-bottom: 1rem; font-size: 2rem;">üöÄ Create Your Own QR Codes</h3>
                <p style="color: #718096; margin-bottom: 2rem; font-size: 1.2rem; max-width: 600px; margin-left: auto; margin-right: auto;">
                    Generate professional QR codes for your files, links, and content with advanced customization options, analytics, and security features
                </p>
                <div class="feature-tags">
                    <span class="feature-tag tag-logo">‚ú® Logo Embedding</span>
                    <span class="feature-tag tag-security">üîí Password Protection</span>
                    <span class="feature-tag tag-analytics">üìä Detailed Analytics</span>
                </div>
                <div style="margin-top: 2rem;">
                    <a href="https://creativeaspirant.com/qr-code-generator/" 
                       style="color: #667eea; text-decoration: none; font-weight: 700; font-size: 1.3rem; padding: 15px 30px; border: 2px solid #667eea; border-radius: 10px; transition: all 0.3s ease; display: inline-block;"
                       onmouseover="this.style.background='#667eea'; this.style.color='white';"
                       onmouseout="this.style.background='transparent'; this.style.color='#667eea';"
                       onclick="gtag('event', 'click', {'event_category': 'footer', 'event_label': 'visit_site', 'value': 1});">
                        üåü Visit Creative Aspirant ‚Üí
                    </a>
                </div>
                <div style="margin-top: 2rem; padding-top: 2rem; border-top: 1px solid #e2e8f0; font-size: 0.9rem; color: #a0aec0;">
                    <p>Powered by Creative Aspirant QR Generator | Professional QR Code Solutions</p>
                </div>
            </div>
        </div>

        <!-- Scroll-triggered Ad -->
        <div class="ad-container" style="margin: 2rem 0; opacity: 0; transform: translateY(20px); transition: all 0.6s ease;" id="scroll-ad">
            <div class="ad-label">Advertisement</div>
            <ins class="adsbygoogle"
                 style="display:block; min-height:100px;"
                 data-ad-client="ca-pub-3577285096347674"
                 data-ad-format="auto"
                 data-full-width-responsive="true"></ins>
        </div>

        <script>
            // Initialize all ads
            (adsbygoogle = window.adsbygoogle || []).push({});
            (adsbygoogle = window.adsbygoogle || []).push({});
            
            // Setup scroll-triggered ad
            document.addEventListener('DOMContentLoaded', function() {
                const scrollAd = document.getElementById('scroll-ad');
                if (scrollAd) {
                    const observer = new IntersectionObserver((entries) => {
                        entries.forEach(entry => {
                            if (entry.isIntersecting) {
                                entry.target.style.opacity = '1';
                                entry.target.style.transform = 'translateY(0)';
                                // Initialize ad after it becomes visible
                                (adsbygoogle = window.adsbygoogle || []).push({});
                            }
                        });
                    }, { threshold: 0.3, rootMargin: '0px 0px -50px 0px' });
                    
                    observer.observe(scrollAd);
                }
            });

            // Copy link function
            function copyLink() {
                const url = window.location.href;
                if (navigator.clipboard && window.isSecureContext) {
                    navigator.clipboard.writeText(url).then(() => {
                        showCopySuccess();
                        gtag('event', 'copy_link', {'file_type': '${simpleFileType}', 'method': 'clipboard'});
                    }).catch(() => {
                        fallbackCopyTextToClipboard(url);
                    });
                } else {
                    fallbackCopyTextToClipboard(url);
                }
            }

            function fallbackCopyTextToClipboard(text) {
                const textArea = document.createElement("textarea");
                textArea.value = text;
                textArea.style.position = "fixed";
                textArea.style.top = "0";
                textArea.style.left = "0";
                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();
                try {
                    document.execCommand('copy');
                    showCopySuccess();
                    gtag('event', 'copy_link', {'file_type': '${simpleFileType}', 'method': 'fallback'});
                } catch (err) {
                    console.error('Copy failed', err);
                }
                document.body.removeChild(textArea);
            }

            function showCopySuccess() {
                const btn = document.querySelector('.copy-btn');
                const originalText = btn.innerHTML;
                btn.innerHTML = '‚úÖ Link Copied!';
                btn.style.background = '#38a169';
                btn.style.color = 'white';
                setTimeout(() => {
                    btn.innerHTML = originalText;
                    btn.style.background = '#e2e8f0';
                    btn.style.color = '#4a5568';
                }, 2000);
            }

            // Analytics tracking
            let startTime = Date.now();
            let maxScroll = 0;

            window.addEventListener('scroll', () => {
                const scrollPercent = Math.round((window.scrollY / (document.body.scrollHeight - window.innerHeight)) * 100);
                maxScroll = Math.max(maxScroll, scrollPercent);
            });

            window.addEventListener('beforeunload', () => {
                const timeOnPage = Math.round((Date.now() - startTime) / 1000);
                gtag('event', 'engagement', {
                    'time_on_page': timeOnPage,
                    'max_scroll_depth': maxScroll,
                    'file_type': '${simpleFileType}',
                    'file_size_mb': Math.round(${metadata.size} / (1024 * 1024) * 100) / 100
                });
            });

            // Enhanced viewing functions
            function openFullscreen(img) {
                const modal = document.createElement('div');
                modal.style.cssText = \`
                    position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                    background: rgba(0,0,0,0.9); display: flex; justify-content: center; 
                    align-items: center; z-index: 10000; cursor: pointer;
                \`;
                
                const fullImg = document.createElement('img');
                fullImg.src = img.src;
                fullImg.style.cssText = \`
                    max-width: 95%; max-height: 95%; object-fit: contain; 
                    border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.5);
                \`;
                
                const closeBtn = document.createElement('div');
                closeBtn.innerHTML = '‚úï';
                closeBtn.style.cssText = \`
                    position: absolute; top: 20px; right: 30px; color: white; 
                    font-size: 2rem; cursor: pointer; z-index: 10001;
                    background: rgba(0,0,0,0.5); width: 40px; height: 40px;
                    border-radius: 50%; display: flex; align-items: center; justify-content: center;
                \`;
                
                modal.appendChild(fullImg);
                modal.appendChild(closeBtn);
                document.body.appendChild(modal);
                
                modal.onclick = closeBtn.onclick = () => document.body.removeChild(modal);
                
                gtag('event', 'image_fullscreen', {'file_type': '${simpleFileType}'});
            }

            function toggleFullscreenPDF(pdfUrl) {
                const modal = document.createElement('div');
                modal.style.cssText = \`
                    position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                    background: rgba(0,0,0,0.95); z-index: 10000; padding: 20px; box-sizing: border-box;
                \`;
                
                const iframe = document.createElement('iframe');
                iframe.src = pdfUrl;
                iframe.style.cssText = \`
                    width: 100%; height: calc(100% - 60px); border: none; 
                    border-radius: 8px; background: white;
                \`;
                
                const toolbar = document.createElement('div');
                toolbar.style.cssText = \`
                    height: 50px; display: flex; justify-content: space-between; 
                    align-items: center; margin-bottom: 10px; color: white;
                \`;
                
                const title = document.createElement('span');
                title.textContent = 'üìñ PDF Fullscreen View';
                title.style.fontWeight = 'bold';
                
                const closeBtn = document.createElement('button');
                closeBtn.innerHTML = '‚úï Close';
                closeBtn.style.cssText = \`
                    background: #dc2626; color: white; border: none; padding: 8px 16px; 
                    border-radius: 6px; cursor: pointer; font-weight: bold;
                \`;
                closeBtn.onclick = () => document.body.removeChild(modal);
                
                toolbar.appendChild(title);
                toolbar.appendChild(closeBtn);
                modal.appendChild(toolbar);
                modal.appendChild(iframe);
                document.body.appendChild(modal);
                
                gtag('event', 'pdf_fullscreen', {'file_type': '${simpleFileType}'});
            }

            async function loadTextPreview(textUrl) {
                const preview = document.getElementById('text-preview');
                preview.innerHTML = '<p class="text-center text-gray-500">üì• Loading preview...</p>';
                
                try {
                    const response = await fetch(textUrl);
                    if (!response.ok) throw new Error('Failed to load file');
                    
                    const text = await response.text();
                    const truncatedText = text.length > 5000 ? text.substring(0, 5000) + '\\n\\n... (truncated, download full file)' : text;
                    
                    preview.innerHTML = \`
                        <pre style="white-space: pre-wrap; font-family: 'Courier New', monospace; 
                                    font-size: 14px; line-height: 1.5; color: #374151; background: white; 
                                    padding: 1rem; border-radius: 6px; border: 1px solid #d1d5db;">\${truncatedText.replace(/</g, '&lt;').replace(/>/g, '&gt;')}</pre>
                    \`;
                    
                    gtag('event', 'text_preview_loaded', {'file_type': '${simpleFileType}'});
                } catch (error) {
                    preview.innerHTML = \`
                        <div class="text-center text-red-600">
                            <p>‚ùå Could not load preview</p>
                            <p class="text-sm">Please download the file to view its content</p>
                        </div>
                    \`;
                }
            }
        </script>
    </body>
    </html>
  `;
}
